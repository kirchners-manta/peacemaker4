module test_auxiliary
    use testdrive, only : new_unittest, unittest_type, error_type, check
    use kinds, only : dp
    !> imports go here
    implicit none
    private
  
    public :: collect_auxiliary
  
  contains
  
  !> Collect all exported unit tests
  subroutine collect_auxiliary(testsuite)
    !> Collection of tests
    type(unittest_type), allocatable, intent(out) :: testsuite(:)
  
    testsuite = [ &
      new_unittest("test_ln_factorial", test_ln_factorial), &
      new_unittest("test_ln_factorial_2", test_ln_factorial_2, should_fail=.true.), &
      new_unittest("test_ln_factorial_3", test_ln_factorial_3), &
      new_unittest("test_ln_factorial_4", test_ln_factorial_4), &
      new_unittest("test_derivative", test_derivative), &
      new_unittest("test_derivative_2", test_derivative_2), &
      new_unittest("test_derivative_3", test_derivative_3) &
      ]
  
  end subroutine collect_auxiliary
  

!--------------------------------------
! Unit tests for calculation of ln(n!)
!--------------------------------------
  ! Gives infinity for negative input.
  ! This is no problem since it is only called with non-negative integers. (Populations)
  subroutine test_ln_factorial(error)
    use auxiliary, only : ln_factorial
    !> Precision of the test
    real(dp) :: thr = 1.0e-5_dp

    ! Arguments
    type(error_type), allocatable, intent(out) :: error
    real(dp) :: x = 0.0_dp

    ! Expected result
    real(dp) :: expected = 0.0_dp

    ! Computed result
    real(dp) :: computed

    ! Call the function
    computed = ln_factorial(x)

    call check(error, computed, expected, thr=thr, rel=.false.)
  end subroutine test_ln_factorial

  subroutine test_ln_factorial_2(error)
    use auxiliary, only : ln_factorial
    !> Precision of the test
    real(dp) :: thr = 1.0e-5_dp

    ! Arguments
    type(error_type), allocatable, intent(out) :: error
    real(dp) :: x = -1.0_dp

    ! Expected result
    real(dp) :: expected = 0.0_dp

    ! Computed result
    real(dp) :: computed

    ! Call the function
    computed = ln_factorial(x)

    call check(error, computed, expected, thr=thr, rel=.false.)
  end subroutine test_ln_factorial_2
  
  subroutine test_ln_factorial_3(error)
    use auxiliary, only : ln_factorial
    !> Precision of the test
    real(dp) :: thr = 1.0e-5_dp

    ! Arguments
    type(error_type), allocatable, intent(out) :: error
    real(dp) :: x = 300.0_dp

    ! Expected result
    real(dp) :: expected = 1414.9058499450679885_dp

    ! Computed result
    real(dp) :: computed

    ! Call the function
    computed = ln_factorial(x)

    call check(error, computed, expected, thr=thr, rel=.false.)
  end subroutine test_ln_factorial_3

  subroutine test_ln_factorial_4(error)
    use auxiliary, only : ln_factorial
    !> Precision of the test
    real(dp) :: thr = 1.0e-5_dp

    ! Arguments
    type(error_type), allocatable, intent(out) :: error
    real(dp) :: x = 0.021_dp

    ! Expected result
    real(dp) :: expected = -0.0117625_dp

    ! Computed result
    real(dp) :: computed

    ! Call the function
    computed = ln_factorial(x)

    call check(error, computed, expected, thr=thr, rel=.false.)
  end subroutine test_ln_factorial_4

!--------------------------------------
! Unit tests for calculation derivative
!--------------------------------------
  ! Gives infinity for negative input.
  ! This is no problem since it is only called with non-negative integers. (Populations)
  subroutine test_derivative(error)
    ! f(x) = x 
    ! from -2 to 2 in steps op 0.5
    use auxiliary, only : derivative
    !> Precision of the test
    real(dp) :: thr = 1.0e-5_dp

    ! Arguments
    type(error_type), allocatable, intent(out) :: error
    real(dp), dimension(9) :: x = [-2.0_dp, -1.5_dp, -1.0_dp, -0.5_dp, 0.0_dp, 0.5_dp, 1.0_dp, 1.5_dp, 2.0_dp]
    real(dp), dimension(9) :: y = [-2.0_dp, -1.5_dp, -1.0_dp, -0.5_dp, 0.0_dp, 0.5_dp, 1.0_dp, 1.5_dp, 2.0_dp]
    integer :: i

    ! Expected result
    real(dp), dimension(9) :: expected = [1.0_dp, 1.0_dp, 1.0_dp, 1.0_dp, 1.0_dp, 1.0_dp, 1.0_dp, 1.0_dp, 1.0_dp]

    ! Computed result
    real(dp), dimension(9) :: computed

    ! Call the function
    computed = derivative(y, x)

    do i = 1, 9
      call check(error, computed(i), expected(i), thr=thr, rel=.false.)
    end do
  end subroutine test_derivative

  subroutine test_derivative_2(error)
    ! f(x) = x^2
    ! from 0.5 to 1 in steps of 0.001
    use auxiliary, only : derivative
    !> Precision of the test
    real(dp) :: thr = 1.0e-3_dp

    ! Arguments
    type(error_type), allocatable, intent(out) :: error
    integer :: i
    real(dp), dimension(500) :: x = [0.500000_dp, 0.501000_dp, 0.502000_dp, 0.503000_dp, 0.504000_dp, 0.505000_dp, 0.506000_dp, &
                                     0.507000_dp, 0.508000_dp, 0.509000_dp, 0.510000_dp, 0.511000_dp, 0.512000_dp, 0.513000_dp, &
                                     0.514000_dp, 0.515000_dp, 0.516000_dp, 0.517000_dp, 0.518000_dp, 0.519000_dp, 0.520000_dp, &
                                     0.521000_dp, 0.522000_dp, 0.523000_dp, 0.524000_dp, 0.525000_dp, 0.526000_dp, 0.527000_dp, &
                                     0.528000_dp, 0.529000_dp, 0.530000_dp, 0.531000_dp, 0.532000_dp, 0.533000_dp, 0.534000_dp, &
                                     0.535000_dp, 0.536000_dp, 0.537000_dp, 0.538000_dp, 0.539000_dp, 0.540000_dp, 0.541000_dp, &
                                     0.542000_dp, 0.543000_dp, 0.544000_dp, 0.545000_dp, 0.546000_dp, 0.547000_dp, 0.548000_dp, &
                                     0.549000_dp, 0.550000_dp, 0.551000_dp, 0.552000_dp, 0.553000_dp, 0.554000_dp, 0.555000_dp, &
                                     0.556000_dp, 0.557000_dp, 0.558000_dp, 0.559000_dp, 0.560000_dp, 0.561000_dp, 0.562000_dp, &
                                     0.563000_dp, 0.564000_dp, 0.565000_dp, 0.566000_dp, 0.567000_dp, 0.568000_dp, 0.569000_dp, &
                                     0.570000_dp, 0.571000_dp, 0.572000_dp, 0.573000_dp, 0.574000_dp, 0.575000_dp, 0.576000_dp, &
                                     0.577000_dp, 0.578000_dp, 0.579000_dp, 0.580000_dp, 0.581000_dp, 0.582000_dp, 0.583000_dp, &
                                     0.584000_dp, 0.585000_dp, 0.586000_dp, 0.587000_dp, 0.588000_dp, 0.589000_dp, 0.590000_dp, &
                                     0.591000_dp, 0.592000_dp, 0.593000_dp, 0.594000_dp, 0.595000_dp, 0.596000_dp, 0.597000_dp, &
                                     0.598000_dp, 0.599000_dp, 0.600000_dp, 0.601000_dp, 0.602000_dp, 0.603000_dp, 0.604000_dp, &
                                     0.605000_dp, 0.606000_dp, 0.607000_dp, 0.608000_dp, 0.609000_dp, 0.610000_dp, 0.611000_dp, &
                                     0.612000_dp, 0.613000_dp, 0.614000_dp, 0.615000_dp, 0.616000_dp, 0.617000_dp, 0.618000_dp, &
                                     0.619000_dp, 0.620000_dp, 0.621000_dp, 0.622000_dp, 0.623000_dp, 0.624000_dp, 0.625000_dp, &
                                     0.626000_dp, 0.627000_dp, 0.628000_dp, 0.629000_dp, 0.630000_dp, 0.631000_dp, 0.632000_dp, &
                                     0.633000_dp, 0.634000_dp, 0.635000_dp, 0.636000_dp, 0.637000_dp, 0.638000_dp, 0.639000_dp, &
                                     0.640000_dp, 0.641000_dp, 0.642000_dp, 0.643000_dp, 0.644000_dp, 0.645000_dp, 0.646000_dp, &
                                     0.647000_dp, 0.648000_dp, 0.649000_dp, 0.650000_dp, 0.651000_dp, 0.652000_dp, 0.653000_dp, &
                                     0.654000_dp, 0.655000_dp, 0.656000_dp, 0.657000_dp, 0.658000_dp, 0.659000_dp, 0.660000_dp, &
                                     0.661000_dp, 0.662000_dp, 0.663000_dp, 0.664000_dp, 0.665000_dp, 0.666000_dp, 0.667000_dp, &
                                     0.668000_dp, 0.669000_dp, 0.670000_dp, 0.671000_dp, 0.672000_dp, 0.673000_dp, 0.674000_dp, &
                                     0.675000_dp, 0.676000_dp, 0.677000_dp, 0.678000_dp, 0.679000_dp, 0.680000_dp, 0.681000_dp, &
                                     0.682000_dp, 0.683000_dp, 0.684000_dp, 0.685000_dp, 0.686000_dp, 0.687000_dp, 0.688000_dp, &
                                     0.689000_dp, 0.690000_dp, 0.691000_dp, 0.692000_dp, 0.693000_dp, 0.694000_dp, 0.695000_dp, &
                                     0.696000_dp, 0.697000_dp, 0.698000_dp, 0.699000_dp, 0.700000_dp, 0.701000_dp, 0.702000_dp, &
                                     0.703000_dp, 0.704000_dp, 0.705000_dp, 0.706000_dp, 0.707000_dp, 0.708000_dp, 0.709000_dp, &
                                     0.710000_dp, 0.711000_dp, 0.712000_dp, 0.713000_dp, 0.714000_dp, 0.715000_dp, 0.716000_dp, &
                                     0.717000_dp, 0.718000_dp, 0.719000_dp, 0.720000_dp, 0.721000_dp, 0.722000_dp, 0.723000_dp, &
                                     0.724000_dp, 0.725000_dp, 0.726000_dp, 0.727000_dp, 0.728000_dp, 0.729000_dp, 0.730000_dp, &
                                     0.731000_dp, 0.732000_dp, 0.733000_dp, 0.734000_dp, 0.735000_dp, 0.736000_dp, 0.737000_dp, &
                                     0.738000_dp, 0.739000_dp, 0.740000_dp, 0.741000_dp, 0.742000_dp, 0.743000_dp, 0.744000_dp, &
                                     0.745000_dp, 0.746000_dp, 0.747000_dp, 0.748000_dp, 0.749000_dp, 0.750000_dp, 0.751000_dp, &
                                     0.752000_dp, 0.753000_dp, 0.754000_dp, 0.755000_dp, 0.756000_dp, 0.757000_dp, 0.758000_dp, &
                                     0.759000_dp, 0.760000_dp, 0.761000_dp, 0.762000_dp, 0.763000_dp, 0.764000_dp, 0.765000_dp, &
                                     0.766000_dp, 0.767000_dp, 0.768000_dp, 0.769000_dp, 0.770000_dp, 0.771000_dp, 0.772000_dp, &
                                     0.773000_dp, 0.774000_dp, 0.775000_dp, 0.776000_dp, 0.777000_dp, 0.778000_dp, 0.779000_dp, &
                                     0.780000_dp, 0.781000_dp, 0.782000_dp, 0.783000_dp, 0.784000_dp, 0.785000_dp, 0.786000_dp, &
                                     0.787000_dp, 0.788000_dp, 0.789000_dp, 0.790000_dp, 0.791000_dp, 0.792000_dp, 0.793000_dp, &
                                     0.794000_dp, 0.795000_dp, 0.796000_dp, 0.797000_dp, 0.798000_dp, 0.799000_dp, 0.800000_dp, &
                                     0.801000_dp, 0.802000_dp, 0.803000_dp, 0.804000_dp, 0.805000_dp, 0.806000_dp, 0.807000_dp, &
                                     0.808000_dp, 0.809000_dp, 0.810000_dp, 0.811000_dp, 0.812000_dp, 0.813000_dp, 0.814000_dp, &
                                     0.815000_dp, 0.816000_dp, 0.817000_dp, 0.818000_dp, 0.819000_dp, 0.820000_dp, 0.821000_dp, &
                                     0.822000_dp, 0.823000_dp, 0.824000_dp, 0.825000_dp, 0.826000_dp, 0.827000_dp, 0.828000_dp, &
                                     0.829000_dp, 0.830000_dp, 0.831000_dp, 0.832000_dp, 0.833000_dp, 0.834000_dp, 0.835000_dp, &
                                     0.836000_dp, 0.837000_dp, 0.838000_dp, 0.839000_dp, 0.840000_dp, 0.841000_dp, 0.842000_dp, &
                                     0.843000_dp, 0.844000_dp, 0.845000_dp, 0.846000_dp, 0.847000_dp, 0.848000_dp, 0.849000_dp, &
                                     0.850000_dp, 0.851000_dp, 0.852000_dp, 0.853000_dp, 0.854000_dp, 0.855000_dp, 0.856000_dp, &
                                     0.857000_dp, 0.858000_dp, 0.859000_dp, 0.860000_dp, 0.861000_dp, 0.862000_dp, 0.863000_dp, &
                                     0.864000_dp, 0.865000_dp, 0.866000_dp, 0.867000_dp, 0.868000_dp, 0.869000_dp, 0.870000_dp, &
                                     0.871000_dp, 0.872000_dp, 0.873000_dp, 0.874000_dp, 0.875000_dp, 0.876000_dp, 0.877000_dp, &
                                     0.878000_dp, 0.879000_dp, 0.880000_dp, 0.881000_dp, 0.882000_dp, 0.883000_dp, 0.884000_dp, &
                                     0.885000_dp, 0.886000_dp, 0.887000_dp, 0.888000_dp, 0.889000_dp, 0.890000_dp, 0.891000_dp, &
                                     0.892000_dp, 0.893000_dp, 0.894000_dp, 0.895000_dp, 0.896000_dp, 0.897000_dp, 0.898000_dp, &
                                     0.899000_dp, 0.900000_dp, 0.901000_dp, 0.902000_dp, 0.903000_dp, 0.904000_dp, 0.905000_dp, &
                                     0.906000_dp, 0.907000_dp, 0.908000_dp, 0.909000_dp, 0.910000_dp, 0.911000_dp, 0.912000_dp, &
                                     0.913000_dp, 0.914000_dp, 0.915000_dp, 0.916000_dp, 0.917000_dp, 0.918000_dp, 0.919000_dp, &
                                     0.920000_dp, 0.921000_dp, 0.922000_dp, 0.923000_dp, 0.924000_dp, 0.925000_dp, 0.926000_dp, &
                                     0.927000_dp, 0.928000_dp, 0.929000_dp, 0.930000_dp, 0.931000_dp, 0.932000_dp, 0.933000_dp, &
                                     0.934000_dp, 0.935000_dp, 0.936000_dp, 0.937000_dp, 0.938000_dp, 0.939000_dp, 0.940000_dp, &
                                     0.941000_dp, 0.942000_dp, 0.943000_dp, 0.944000_dp, 0.945000_dp, 0.946000_dp, 0.947000_dp, &
                                     0.948000_dp, 0.949000_dp, 0.950000_dp, 0.951000_dp, 0.952000_dp, 0.953000_dp, 0.954000_dp, &
                                     0.955000_dp, 0.956000_dp, 0.957000_dp, 0.958000_dp, 0.959000_dp, 0.960000_dp, 0.961000_dp, &
                                     0.962000_dp, 0.963000_dp, 0.964000_dp, 0.965000_dp, 0.966000_dp, 0.967000_dp, 0.968000_dp, &
                                     0.969000_dp, 0.970000_dp, 0.971000_dp, 0.972000_dp, 0.973000_dp, 0.974000_dp, 0.975000_dp, &
                                     0.976000_dp, 0.977000_dp, 0.978000_dp, 0.979000_dp, 0.980000_dp, 0.981000_dp, 0.982000_dp, &
                                     0.983000_dp, 0.984000_dp, 0.985000_dp, 0.986000_dp, 0.987000_dp, 0.988000_dp, 0.989000_dp, &
                                     0.990000_dp, 0.991000_dp, 0.992000_dp, 0.993000_dp, 0.994000_dp, 0.995000_dp, 0.996000_dp, &
                                     0.997000_dp, 0.998000_dp, 0.999000_dp]
real(dp), dimension(500) :: y = [0.250000_dp, 0.251001_dp, 0.252004_dp, 0.253009_dp, 0.254016_dp, 0.255025_dp, 0.256036_dp, &
                                     0.257049_dp, 0.258064_dp, 0.259081_dp, 0.260100_dp, 0.261121_dp, 0.262144_dp, 0.263169_dp, &
                                     0.264196_dp, 0.265225_dp, 0.266256_dp, 0.267289_dp, 0.268324_dp, 0.269361_dp, 0.270400_dp, &
                                     0.271441_dp, 0.272484_dp, 0.273529_dp, 0.274576_dp, 0.275625_dp, 0.276676_dp, 0.277729_dp, &
                                     0.278784_dp, 0.279841_dp, 0.280900_dp, 0.281961_dp, 0.283024_dp, 0.284089_dp, 0.285156_dp, &
                                     0.286225_dp, 0.287296_dp, 0.288369_dp, 0.289444_dp, 0.290521_dp, 0.291600_dp, 0.292681_dp, &
                                     0.293764_dp, 0.294849_dp, 0.295936_dp, 0.297025_dp, 0.298116_dp, 0.299209_dp, 0.300304_dp, &
                                     0.301401_dp, 0.302500_dp, 0.303601_dp, 0.304704_dp, 0.305809_dp, 0.306916_dp, 0.308025_dp, &
                                     0.309136_dp, 0.310249_dp, 0.311364_dp, 0.312481_dp, 0.313600_dp, 0.314721_dp, 0.315844_dp, &
                                     0.316969_dp, 0.318096_dp, 0.319225_dp, 0.320356_dp, 0.321489_dp, 0.322624_dp, 0.323761_dp, &
                                     0.324900_dp, 0.326041_dp, 0.327184_dp, 0.328329_dp, 0.329476_dp, 0.330625_dp, 0.331776_dp, &
                                     0.332929_dp, 0.334084_dp, 0.335241_dp, 0.336400_dp, 0.337561_dp, 0.338724_dp, 0.339889_dp, &
                                     0.341056_dp, 0.342225_dp, 0.343396_dp, 0.344569_dp, 0.345744_dp, 0.346921_dp, 0.348100_dp, &
                                     0.349281_dp, 0.350464_dp, 0.351649_dp, 0.352836_dp, 0.354025_dp, 0.355216_dp, 0.356409_dp, &
                                     0.357604_dp, 0.358801_dp, 0.360000_dp, 0.361201_dp, 0.362404_dp, 0.363609_dp, 0.364816_dp, &
                                     0.366025_dp, 0.367236_dp, 0.368449_dp, 0.369664_dp, 0.370881_dp, 0.372100_dp, 0.373321_dp, &
                                     0.374544_dp, 0.375769_dp, 0.376996_dp, 0.378225_dp, 0.379456_dp, 0.380689_dp, 0.381924_dp, &
                                     0.383161_dp, 0.384400_dp, 0.385641_dp, 0.386884_dp, 0.388129_dp, 0.389376_dp, 0.390625_dp, &
                                     0.391876_dp, 0.393129_dp, 0.394384_dp, 0.395641_dp, 0.396900_dp, 0.398161_dp, 0.399424_dp, &
                                     0.400689_dp, 0.401956_dp, 0.403225_dp, 0.404496_dp, 0.405769_dp, 0.407044_dp, 0.408321_dp, &
                                     0.409600_dp, 0.410881_dp, 0.412164_dp, 0.413449_dp, 0.414736_dp, 0.416025_dp, 0.417316_dp, &
                                     0.418609_dp, 0.419904_dp, 0.421201_dp, 0.422500_dp, 0.423801_dp, 0.425104_dp, 0.426409_dp, &
                                     0.427716_dp, 0.429025_dp, 0.430336_dp, 0.431649_dp, 0.432964_dp, 0.434281_dp, 0.435600_dp, &
                                     0.436921_dp, 0.438244_dp, 0.439569_dp, 0.440896_dp, 0.442225_dp, 0.443556_dp, 0.444889_dp, &
                                     0.446224_dp, 0.447561_dp, 0.448900_dp, 0.450241_dp, 0.451584_dp, 0.452929_dp, 0.454276_dp, &
                                     0.455625_dp, 0.456976_dp, 0.458329_dp, 0.459684_dp, 0.461041_dp, 0.462400_dp, 0.463761_dp, &
                                     0.465124_dp, 0.466489_dp, 0.467856_dp, 0.469225_dp, 0.470596_dp, 0.471969_dp, 0.473344_dp, &
                                     0.474721_dp, 0.476100_dp, 0.477481_dp, 0.478864_dp, 0.480249_dp, 0.481636_dp, 0.483025_dp, &
                                     0.484416_dp, 0.485809_dp, 0.487204_dp, 0.488601_dp, 0.490000_dp, 0.491401_dp, 0.492804_dp, &
                                     0.494209_dp, 0.495616_dp, 0.497025_dp, 0.498436_dp, 0.499849_dp, 0.501264_dp, 0.502681_dp, &
                                     0.504100_dp, 0.505521_dp, 0.506944_dp, 0.508369_dp, 0.509796_dp, 0.511225_dp, 0.512656_dp, &
                                     0.514089_dp, 0.515524_dp, 0.516961_dp, 0.518400_dp, 0.519841_dp, 0.521284_dp, 0.522729_dp, &
                                     0.524176_dp, 0.525625_dp, 0.527076_dp, 0.528529_dp, 0.529984_dp, 0.531441_dp, 0.532900_dp, &
                                     0.534361_dp, 0.535824_dp, 0.537289_dp, 0.538756_dp, 0.540225_dp, 0.541696_dp, 0.543169_dp, &
                                     0.544644_dp, 0.546121_dp, 0.547600_dp, 0.549081_dp, 0.550564_dp, 0.552049_dp, 0.553536_dp, &
                                     0.555025_dp, 0.556516_dp, 0.558009_dp, 0.559504_dp, 0.561001_dp, 0.562500_dp, 0.564001_dp, &
                                     0.565504_dp, 0.567009_dp, 0.568516_dp, 0.570025_dp, 0.571536_dp, 0.573049_dp, 0.574564_dp, &
                                     0.576081_dp, 0.577600_dp, 0.579121_dp, 0.580644_dp, 0.582169_dp, 0.583696_dp, 0.585225_dp, &
                                     0.586756_dp, 0.588289_dp, 0.589824_dp, 0.591361_dp, 0.592900_dp, 0.594441_dp, 0.595984_dp, &
                                     0.597529_dp, 0.599076_dp, 0.600625_dp, 0.602176_dp, 0.603729_dp, 0.605284_dp, 0.606841_dp, &
                                     0.608400_dp, 0.609961_dp, 0.611524_dp, 0.613089_dp, 0.614656_dp, 0.616225_dp, 0.617796_dp, &
                                     0.619369_dp, 0.620944_dp, 0.622521_dp, 0.624100_dp, 0.625681_dp, 0.627264_dp, 0.628849_dp, &
                                     0.630436_dp, 0.632025_dp, 0.633616_dp, 0.635209_dp, 0.636804_dp, 0.638401_dp, 0.640000_dp, &
                                     0.641601_dp, 0.643204_dp, 0.644809_dp, 0.646416_dp, 0.648025_dp, 0.649636_dp, 0.651249_dp, &
                                     0.652864_dp, 0.654481_dp, 0.656100_dp, 0.657721_dp, 0.659344_dp, 0.660969_dp, 0.662596_dp, &
                                     0.664225_dp, 0.665856_dp, 0.667489_dp, 0.669124_dp, 0.670761_dp, 0.672400_dp, 0.674041_dp, &
                                     0.675684_dp, 0.677329_dp, 0.678976_dp, 0.680625_dp, 0.682276_dp, 0.683929_dp, 0.685584_dp, &
                                     0.687241_dp, 0.688900_dp, 0.690561_dp, 0.692224_dp, 0.693889_dp, 0.695556_dp, 0.697225_dp, &
                                     0.698896_dp, 0.700569_dp, 0.702244_dp, 0.703921_dp, 0.705600_dp, 0.707281_dp, 0.708964_dp, &
                                     0.710649_dp, 0.712336_dp, 0.714025_dp, 0.715716_dp, 0.717409_dp, 0.719104_dp, 0.720801_dp, &
                                     0.722500_dp, 0.724201_dp, 0.725904_dp, 0.727609_dp, 0.729316_dp, 0.731025_dp, 0.732736_dp, &
                                     0.734449_dp, 0.736164_dp, 0.737881_dp, 0.739600_dp, 0.741321_dp, 0.743044_dp, 0.744769_dp, &
                                     0.746496_dp, 0.748225_dp, 0.749956_dp, 0.751689_dp, 0.753424_dp, 0.755161_dp, 0.756900_dp, &
                                     0.758641_dp, 0.760384_dp, 0.762129_dp, 0.763876_dp, 0.765625_dp, 0.767376_dp, 0.769129_dp, &
                                     0.770884_dp, 0.772641_dp, 0.774400_dp, 0.776161_dp, 0.777924_dp, 0.779689_dp, 0.781456_dp, &
                                     0.783225_dp, 0.784996_dp, 0.786769_dp, 0.788544_dp, 0.790321_dp, 0.792100_dp, 0.793881_dp, &
                                     0.795664_dp, 0.797449_dp, 0.799236_dp, 0.801025_dp, 0.802816_dp, 0.804609_dp, 0.806404_dp, &
                                     0.808201_dp, 0.810000_dp, 0.811801_dp, 0.813604_dp, 0.815409_dp, 0.817216_dp, 0.819025_dp, &
                                     0.820836_dp, 0.822649_dp, 0.824464_dp, 0.826281_dp, 0.828100_dp, 0.829921_dp, 0.831744_dp, &
                                     0.833569_dp, 0.835396_dp, 0.837225_dp, 0.839056_dp, 0.840889_dp, 0.842724_dp, 0.844561_dp, &
                                     0.846400_dp, 0.848241_dp, 0.850084_dp, 0.851929_dp, 0.853776_dp, 0.855625_dp, 0.857476_dp, &
                                     0.859329_dp, 0.861184_dp, 0.863041_dp, 0.864900_dp, 0.866761_dp, 0.868624_dp, 0.870489_dp, &
                                     0.872356_dp, 0.874225_dp, 0.876096_dp, 0.877969_dp, 0.879844_dp, 0.881721_dp, 0.883600_dp, &
                                     0.885481_dp, 0.887364_dp, 0.889249_dp, 0.891136_dp, 0.893025_dp, 0.894916_dp, 0.896809_dp, &
                                     0.898704_dp, 0.900601_dp, 0.902500_dp, 0.904401_dp, 0.906304_dp, 0.908209_dp, 0.910116_dp, &
                                     0.912025_dp, 0.913936_dp, 0.915849_dp, 0.917764_dp, 0.919681_dp, 0.921600_dp, 0.923521_dp, &
                                     0.925444_dp, 0.927369_dp, 0.929296_dp, 0.931225_dp, 0.933156_dp, 0.935089_dp, 0.937024_dp, &
                                     0.938961_dp, 0.940900_dp, 0.942841_dp, 0.944784_dp, 0.946729_dp, 0.948676_dp, 0.950625_dp, &
                                     0.952576_dp, 0.954529_dp, 0.956484_dp, 0.958441_dp, 0.960400_dp, 0.962361_dp, 0.964324_dp, &
                                     0.966289_dp, 0.968256_dp, 0.970225_dp, 0.972196_dp, 0.974169_dp, 0.976144_dp, 0.978121_dp, &
                                     0.980100_dp, 0.982081_dp, 0.984064_dp, 0.986049_dp, 0.988036_dp, 0.990025_dp, 0.992016_dp, &
                                     0.994009_dp, 0.996004_dp, 0.998001_dp]
real(dp), dimension(500) :: expected = [1.000000_dp, 1.002000_dp, 1.004000_dp, 1.006000_dp, 1.008000_dp, 1.010000_dp, 1.012000_dp, &
                                        1.014000_dp, 1.016000_dp, 1.018000_dp, 1.020000_dp, 1.022000_dp, 1.024000_dp, 1.026000_dp, &
                                        1.028000_dp, 1.030000_dp, 1.032000_dp, 1.034000_dp, 1.036000_dp, 1.038000_dp, 1.040000_dp, &
                                        1.042000_dp, 1.044000_dp, 1.046000_dp, 1.048000_dp, 1.050000_dp, 1.052000_dp, 1.054000_dp, &
                                        1.056000_dp, 1.058000_dp, 1.060000_dp, 1.062000_dp, 1.064000_dp, 1.066000_dp, 1.068000_dp, &
                                        1.070000_dp, 1.072000_dp, 1.074000_dp, 1.076000_dp, 1.078000_dp, 1.080000_dp, 1.082000_dp, &
                                        1.084000_dp, 1.086000_dp, 1.088000_dp, 1.090000_dp, 1.092000_dp, 1.094000_dp, 1.096000_dp, &
                                        1.098000_dp, 1.100000_dp, 1.102000_dp, 1.104000_dp, 1.106000_dp, 1.108000_dp, 1.110000_dp, &
                                        1.112000_dp, 1.114000_dp, 1.116000_dp, 1.118000_dp, 1.120000_dp, 1.122000_dp, 1.124000_dp, &
                                        1.126000_dp, 1.128000_dp, 1.130000_dp, 1.132000_dp, 1.134000_dp, 1.136000_dp, 1.138000_dp, &
                                        1.140000_dp, 1.142000_dp, 1.144000_dp, 1.146000_dp, 1.148000_dp, 1.150000_dp, 1.152000_dp, &
                                        1.154000_dp, 1.156000_dp, 1.158000_dp, 1.160000_dp, 1.162000_dp, 1.164000_dp, 1.166000_dp, &
                                        1.168000_dp, 1.170000_dp, 1.172000_dp, 1.174000_dp, 1.176000_dp, 1.178000_dp, 1.180000_dp, &
                                        1.182000_dp, 1.184000_dp, 1.186000_dp, 1.188000_dp, 1.190000_dp, 1.192000_dp, 1.194000_dp, &
                                        1.196000_dp, 1.198000_dp, 1.200000_dp, 1.202000_dp, 1.204000_dp, 1.206000_dp, 1.208000_dp, &
                                        1.210000_dp, 1.212000_dp, 1.214000_dp, 1.216000_dp, 1.218000_dp, 1.220000_dp, 1.222000_dp, &
                                        1.224000_dp, 1.226000_dp, 1.228000_dp, 1.230000_dp, 1.232000_dp, 1.234000_dp, 1.236000_dp, &
                                        1.238000_dp, 1.240000_dp, 1.242000_dp, 1.244000_dp, 1.246000_dp, 1.248000_dp, 1.250000_dp, &
                                        1.252000_dp, 1.254000_dp, 1.256000_dp, 1.258000_dp, 1.260000_dp, 1.262000_dp, 1.264000_dp, &
                                        1.266000_dp, 1.268000_dp, 1.270000_dp, 1.272000_dp, 1.274000_dp, 1.276000_dp, 1.278000_dp, &
                                        1.280000_dp, 1.282000_dp, 1.284000_dp, 1.286000_dp, 1.288000_dp, 1.290000_dp, 1.292000_dp, &
                                        1.294000_dp, 1.296000_dp, 1.298000_dp, 1.300000_dp, 1.302000_dp, 1.304000_dp, 1.306000_dp, &
                                        1.308000_dp, 1.310000_dp, 1.312000_dp, 1.314000_dp, 1.316000_dp, 1.318000_dp, 1.320000_dp, &
                                        1.322000_dp, 1.324000_dp, 1.326000_dp, 1.328000_dp, 1.330000_dp, 1.332000_dp, 1.334000_dp, &
                                        1.336000_dp, 1.338000_dp, 1.340000_dp, 1.342000_dp, 1.344000_dp, 1.346000_dp, 1.348000_dp, &
                                        1.350000_dp, 1.352000_dp, 1.354000_dp, 1.356000_dp, 1.358000_dp, 1.360000_dp, 1.362000_dp, &
                                        1.364000_dp, 1.366000_dp, 1.368000_dp, 1.370000_dp, 1.372000_dp, 1.374000_dp, 1.376000_dp, &
                                        1.378000_dp, 1.380000_dp, 1.382000_dp, 1.384000_dp, 1.386000_dp, 1.388000_dp, 1.390000_dp, &
                                        1.392000_dp, 1.394000_dp, 1.396000_dp, 1.398000_dp, 1.400000_dp, 1.402000_dp, 1.404000_dp, &
                                        1.406000_dp, 1.408000_dp, 1.410000_dp, 1.412000_dp, 1.414000_dp, 1.416000_dp, 1.418000_dp, &
                                        1.420000_dp, 1.422000_dp, 1.424000_dp, 1.426000_dp, 1.428000_dp, 1.430000_dp, 1.432000_dp, &
                                        1.434000_dp, 1.436000_dp, 1.438000_dp, 1.440000_dp, 1.442000_dp, 1.444000_dp, 1.446000_dp, &
                                        1.448000_dp, 1.450000_dp, 1.452000_dp, 1.454000_dp, 1.456000_dp, 1.458000_dp, 1.460000_dp, &
                                        1.462000_dp, 1.464000_dp, 1.466000_dp, 1.468000_dp, 1.470000_dp, 1.472000_dp, 1.474000_dp, &
                                        1.476000_dp, 1.478000_dp, 1.480000_dp, 1.482000_dp, 1.484000_dp, 1.486000_dp, 1.488000_dp, &
                                        1.490000_dp, 1.492000_dp, 1.494000_dp, 1.496000_dp, 1.498000_dp, 1.500000_dp, 1.502000_dp, &
                                        1.504000_dp, 1.506000_dp, 1.508000_dp, 1.510000_dp, 1.512000_dp, 1.514000_dp, 1.516000_dp, &
                                        1.518000_dp, 1.520000_dp, 1.522000_dp, 1.524000_dp, 1.526000_dp, 1.528000_dp, 1.530000_dp, &
                                        1.532000_dp, 1.534000_dp, 1.536000_dp, 1.538000_dp, 1.540000_dp, 1.542000_dp, 1.544000_dp, &
                                        1.546000_dp, 1.548000_dp, 1.550000_dp, 1.552000_dp, 1.554000_dp, 1.556000_dp, 1.558000_dp, &
                                        1.560000_dp, 1.562000_dp, 1.564000_dp, 1.566000_dp, 1.568000_dp, 1.570000_dp, 1.572000_dp, &
                                        1.574000_dp, 1.576000_dp, 1.578000_dp, 1.580000_dp, 1.582000_dp, 1.584000_dp, 1.586000_dp, &
                                        1.588000_dp, 1.590000_dp, 1.592000_dp, 1.594000_dp, 1.596000_dp, 1.598000_dp, 1.600000_dp, &
                                        1.602000_dp, 1.604000_dp, 1.606000_dp, 1.608000_dp, 1.610000_dp, 1.612000_dp, 1.614000_dp, &
                                        1.616000_dp, 1.618000_dp, 1.620000_dp, 1.622000_dp, 1.624000_dp, 1.626000_dp, 1.628000_dp, &
                                        1.630000_dp, 1.632000_dp, 1.634000_dp, 1.636000_dp, 1.638000_dp, 1.640000_dp, 1.642000_dp, &
                                        1.644000_dp, 1.646000_dp, 1.648000_dp, 1.650000_dp, 1.652000_dp, 1.654000_dp, 1.656000_dp, &
                                        1.658000_dp, 1.660000_dp, 1.662000_dp, 1.664000_dp, 1.666000_dp, 1.668000_dp, 1.670000_dp, &
                                        1.672000_dp, 1.674000_dp, 1.676000_dp, 1.678000_dp, 1.680000_dp, 1.682000_dp, 1.684000_dp, &
                                        1.686000_dp, 1.688000_dp, 1.690000_dp, 1.692000_dp, 1.694000_dp, 1.696000_dp, 1.698000_dp, &
                                        1.700000_dp, 1.702000_dp, 1.704000_dp, 1.706000_dp, 1.708000_dp, 1.710000_dp, 1.712000_dp, &
                                        1.714000_dp, 1.716000_dp, 1.718000_dp, 1.720000_dp, 1.722000_dp, 1.724000_dp, 1.726000_dp, &
                                        1.728000_dp, 1.730000_dp, 1.732000_dp, 1.734000_dp, 1.736000_dp, 1.738000_dp, 1.740000_dp, &
                                        1.742000_dp, 1.744000_dp, 1.746000_dp, 1.748000_dp, 1.750000_dp, 1.752000_dp, 1.754000_dp, &
                                        1.756000_dp, 1.758000_dp, 1.760000_dp, 1.762000_dp, 1.764000_dp, 1.766000_dp, 1.768000_dp, &
                                        1.770000_dp, 1.772000_dp, 1.774000_dp, 1.776000_dp, 1.778000_dp, 1.780000_dp, 1.782000_dp, &
                                        1.784000_dp, 1.786000_dp, 1.788000_dp, 1.790000_dp, 1.792000_dp, 1.794000_dp, 1.796000_dp, &
                                        1.798000_dp, 1.800000_dp, 1.802000_dp, 1.804000_dp, 1.806000_dp, 1.808000_dp, 1.810000_dp, &
                                        1.812000_dp, 1.814000_dp, 1.816000_dp, 1.818000_dp, 1.820000_dp, 1.822000_dp, 1.824000_dp, &
                                        1.826000_dp, 1.828000_dp, 1.830000_dp, 1.832000_dp, 1.834000_dp, 1.836000_dp, 1.838000_dp, &
                                        1.840000_dp, 1.842000_dp, 1.844000_dp, 1.846000_dp, 1.848000_dp, 1.850000_dp, 1.852000_dp, &
                                        1.854000_dp, 1.856000_dp, 1.858000_dp, 1.860000_dp, 1.862000_dp, 1.864000_dp, 1.866000_dp, &
                                        1.868000_dp, 1.870000_dp, 1.872000_dp, 1.874000_dp, 1.876000_dp, 1.878000_dp, 1.880000_dp, &
                                        1.882000_dp, 1.884000_dp, 1.886000_dp, 1.888000_dp, 1.890000_dp, 1.892000_dp, 1.894000_dp, &
                                        1.896000_dp, 1.898000_dp, 1.900000_dp, 1.902000_dp, 1.904000_dp, 1.906000_dp, 1.908000_dp, &
                                        1.910000_dp, 1.912000_dp, 1.914000_dp, 1.916000_dp, 1.918000_dp, 1.920000_dp, 1.922000_dp, &
                                        1.924000_dp, 1.926000_dp, 1.928000_dp, 1.930000_dp, 1.932000_dp, 1.934000_dp, 1.936000_dp, &
                                        1.938000_dp, 1.940000_dp, 1.942000_dp, 1.944000_dp, 1.946000_dp, 1.948000_dp, 1.950000_dp, &
                                        1.952000_dp, 1.954000_dp, 1.956000_dp, 1.958000_dp, 1.960000_dp, 1.962000_dp, 1.964000_dp, &
                                        1.966000_dp, 1.968000_dp, 1.970000_dp, 1.972000_dp, 1.974000_dp, 1.976000_dp, 1.978000_dp, &
                                        1.980000_dp, 1.982000_dp, 1.984000_dp, 1.986000_dp, 1.988000_dp, 1.990000_dp, 1.992000_dp, &
                                        1.994000_dp, 1.996000_dp, 1.998000_dp]

    ! Computed result
    real(dp), dimension(500) :: computed
  
    ! Call the function
    computed = derivative(y, x)
  
    do i = 1, 500
      call check(error, computed(i), expected(i), thr=thr, rel=.false.)
    end do
  end subroutine test_derivative_2

  subroutine test_derivative_3(error)
    ! f(x) = x^3 - 2x^2 +x
    ! from 0.8 to 1.1 in steps op 0.001
    use auxiliary, only : derivative
    !> Precision of the test
    real(dp) :: thr = 1.0e-3_dp
    integer :: i

    ! Arguments
    type(error_type), allocatable, intent(out) :: error
    real(dp), dimension(301) :: x = [0.800000_dp, 0.801000_dp, 0.802000_dp, 0.803000_dp, 0.804000_dp, 0.805000_dp, 0.806000_dp, &
                                     0.807000_dp, 0.808000_dp, 0.809000_dp, 0.810000_dp, 0.811000_dp, 0.812000_dp, 0.813000_dp, &
                                     0.814000_dp, 0.815000_dp, 0.816000_dp, 0.817000_dp, 0.818000_dp, 0.819000_dp, 0.820000_dp, &
                                     0.821000_dp, 0.822000_dp, 0.823000_dp, 0.824000_dp, 0.825000_dp, 0.826000_dp, 0.827000_dp, &
                                     0.828000_dp, 0.829000_dp, 0.830000_dp, 0.831000_dp, 0.832000_dp, 0.833000_dp, 0.834000_dp, &
                                     0.835000_dp, 0.836000_dp, 0.837000_dp, 0.838000_dp, 0.839000_dp, 0.840000_dp, 0.841000_dp, &
                                     0.842000_dp, 0.843000_dp, 0.844000_dp, 0.845000_dp, 0.846000_dp, 0.847000_dp, 0.848000_dp, &
                                     0.849000_dp, 0.850000_dp, 0.851000_dp, 0.852000_dp, 0.853000_dp, 0.854000_dp, 0.855000_dp, &
                                     0.856000_dp, 0.857000_dp, 0.858000_dp, 0.859000_dp, 0.860000_dp, 0.861000_dp, 0.862000_dp, &
                                     0.863000_dp, 0.864000_dp, 0.865000_dp, 0.866000_dp, 0.867000_dp, 0.868000_dp, 0.869000_dp, &
                                     0.870000_dp, 0.871000_dp, 0.872000_dp, 0.873000_dp, 0.874000_dp, 0.875000_dp, 0.876000_dp, &
                                     0.877000_dp, 0.878000_dp, 0.879000_dp, 0.880000_dp, 0.881000_dp, 0.882000_dp, 0.883000_dp, &
                                     0.884000_dp, 0.885000_dp, 0.886000_dp, 0.887000_dp, 0.888000_dp, 0.889000_dp, 0.890000_dp, &
                                     0.891000_dp, 0.892000_dp, 0.893000_dp, 0.894000_dp, 0.895000_dp, 0.896000_dp, 0.897000_dp, &
                                     0.898000_dp, 0.899000_dp, 0.900000_dp, 0.901000_dp, 0.902000_dp, 0.903000_dp, 0.904000_dp, &
                                     0.905000_dp, 0.906000_dp, 0.907000_dp, 0.908000_dp, 0.909000_dp, 0.910000_dp, 0.911000_dp, &
                                     0.912000_dp, 0.913000_dp, 0.914000_dp, 0.915000_dp, 0.916000_dp, 0.917000_dp, 0.918000_dp, &
                                     0.919000_dp, 0.920000_dp, 0.921000_dp, 0.922000_dp, 0.923000_dp, 0.924000_dp, 0.925000_dp, &
                                     0.926000_dp, 0.927000_dp, 0.928000_dp, 0.929000_dp, 0.930000_dp, 0.931000_dp, 0.932000_dp, &
                                     0.933000_dp, 0.934000_dp, 0.935000_dp, 0.936000_dp, 0.937000_dp, 0.938000_dp, 0.939000_dp, &
                                     0.940000_dp, 0.941000_dp, 0.942000_dp, 0.943000_dp, 0.944000_dp, 0.945000_dp, 0.946000_dp, &
                                     0.947000_dp, 0.948000_dp, 0.949000_dp, 0.950000_dp, 0.951000_dp, 0.952000_dp, 0.953000_dp, &
                                     0.954000_dp, 0.955000_dp, 0.956000_dp, 0.957000_dp, 0.958000_dp, 0.959000_dp, 0.960000_dp, &
                                     0.961000_dp, 0.962000_dp, 0.963000_dp, 0.964000_dp, 0.965000_dp, 0.966000_dp, 0.967000_dp, &
                                     0.968000_dp, 0.969000_dp, 0.970000_dp, 0.971000_dp, 0.972000_dp, 0.973000_dp, 0.974000_dp, &
                                     0.975000_dp, 0.976000_dp, 0.977000_dp, 0.978000_dp, 0.979000_dp, 0.980000_dp, 0.981000_dp, &
                                     0.982000_dp, 0.983000_dp, 0.984000_dp, 0.985000_dp, 0.986000_dp, 0.987000_dp, 0.988000_dp, &
                                     0.989000_dp, 0.990000_dp, 0.991000_dp, 0.992000_dp, 0.993000_dp, 0.994000_dp, 0.995000_dp, &
                                     0.996000_dp, 0.997000_dp, 0.998000_dp, 0.999000_dp, 1.000000_dp, 1.001000_dp, 1.002000_dp, &
                                     1.003000_dp, 1.004000_dp, 1.005000_dp, 1.006000_dp, 1.007000_dp, 1.008000_dp, 1.009000_dp, &
                                     1.010000_dp, 1.011000_dp, 1.012000_dp, 1.013000_dp, 1.014000_dp, 1.015000_dp, 1.016000_dp, &
                                     1.017000_dp, 1.018000_dp, 1.019000_dp, 1.020000_dp, 1.021000_dp, 1.022000_dp, 1.023000_dp, &
                                     1.024000_dp, 1.025000_dp, 1.026000_dp, 1.027000_dp, 1.028000_dp, 1.029000_dp, 1.030000_dp, &
                                     1.031000_dp, 1.032000_dp, 1.033000_dp, 1.034000_dp, 1.035000_dp, 1.036000_dp, 1.037000_dp, &
                                     1.038000_dp, 1.039000_dp, 1.040000_dp, 1.041000_dp, 1.042000_dp, 1.043000_dp, 1.044000_dp, &
                                     1.045000_dp, 1.046000_dp, 1.047000_dp, 1.048000_dp, 1.049000_dp, 1.050000_dp, 1.051000_dp, &
                                     1.052000_dp, 1.053000_dp, 1.054000_dp, 1.055000_dp, 1.056000_dp, 1.057000_dp, 1.058000_dp, &
                                     1.059000_dp, 1.060000_dp, 1.061000_dp, 1.062000_dp, 1.063000_dp, 1.064000_dp, 1.065000_dp, &
                                     1.066000_dp, 1.067000_dp, 1.068000_dp, 1.069000_dp, 1.070000_dp, 1.071000_dp, 1.072000_dp, &
                                     1.073000_dp, 1.074000_dp, 1.075000_dp, 1.076000_dp, 1.077000_dp, 1.078000_dp, 1.079000_dp, &
                                     1.080000_dp, 1.081000_dp, 1.082000_dp, 1.083000_dp, 1.084000_dp, 1.085000_dp, 1.086000_dp, &
                                     1.087000_dp, 1.088000_dp, 1.089000_dp, 1.090000_dp, 1.091000_dp, 1.092000_dp, 1.093000_dp, &
                                     1.094000_dp, 1.095000_dp, 1.096000_dp, 1.097000_dp, 1.098000_dp, 1.099000_dp, 1.100000_dp]

    real(dp), dimension(301) :: y = [-1.568000_dp, -1.570280_dp, -1.572558_dp, -1.574836_dp, -1.577114_dp, -1.579390_dp, &
                                     -1.581665_dp, -1.583940_dp, -1.586214_dp, -1.588487_dp, -1.590759_dp, -1.593030_dp, &
                                     -1.595301_dp, -1.597570_dp, -1.599839_dp, -1.602107_dp, -1.604374_dp, -1.606639_dp, &
                                     -1.608905_dp, -1.611169_dp, -1.613432_dp, -1.615694_dp, -1.617956_dp, -1.620216_dp, &
                                     -1.622476_dp, -1.624734_dp, -1.626992_dp, -1.629249_dp, -1.631504_dp, -1.633759_dp, &
                                     -1.636013_dp, -1.638266_dp, -1.640518_dp, -1.642768_dp, -1.645018_dp, -1.647267_dp, &
                                     -1.649515_dp, -1.651762_dp, -1.654008_dp, -1.656252_dp, -1.658496_dp, -1.660739_dp, &
                                     -1.662980_dp, -1.665221_dp, -1.667460_dp, -1.669699_dp, -1.671936_dp, -1.674173_dp, &
                                     -1.676408_dp, -1.678642_dp, -1.680875_dp, -1.683107_dp, -1.685338_dp, -1.687568_dp, &
                                     -1.689796_dp, -1.692024_dp, -1.694250_dp, -1.696475_dp, -1.698699_dp, -1.700922_dp, &
                                     -1.703144_dp, -1.705365_dp, -1.707584_dp, -1.709802_dp, -1.712019_dp, -1.714235_dp, &
                                     -1.716450_dp, -1.718664_dp, -1.720876_dp, -1.723087_dp, -1.725297_dp, -1.727506_dp, &
                                     -1.729713_dp, -1.731919_dp, -1.734124_dp, -1.736328_dp, -1.738531_dp, -1.740732_dp, &
                                     -1.742932_dp, -1.745131_dp, -1.747328_dp, -1.749524_dp, -1.751719_dp, -1.753913_dp, &
                                     -1.756105_dp, -1.758296_dp, -1.760486_dp, -1.762674_dp, -1.764861_dp, -1.767047_dp, &
                                     -1.769231_dp, -1.771414_dp, -1.773596_dp, -1.775776_dp, -1.777955_dp, -1.780133_dp, &
                                     -1.782309_dp, -1.784484_dp, -1.786657_dp, -1.788829_dp, -1.791000_dp, -1.793169_dp, &
                                     -1.795337_dp, -1.797504_dp, -1.799669_dp, -1.801832_dp, -1.803995_dp, -1.806155_dp, &
                                     -1.808315_dp, -1.810473_dp, -1.812629_dp, -1.814784_dp, -1.816937_dp, -1.819090_dp, &
                                     -1.821240_dp, -1.823389_dp, -1.825537_dp, -1.827683_dp, -1.829827_dp, -1.831970_dp, &
                                     -1.834112_dp, -1.836252_dp, -1.838391_dp, -1.840528_dp, -1.842663_dp, -1.844797_dp, &
                                     -1.846929_dp, -1.849060_dp, -1.851189_dp, -1.853317_dp, -1.855443_dp, -1.857568_dp, &
                                     -1.859690_dp, -1.861812_dp, -1.863931_dp, -1.866050_dp, -1.868166_dp, -1.870281_dp, &
                                     -1.872394_dp, -1.874506_dp, -1.876616_dp, -1.878724_dp, -1.880831_dp, -1.882936_dp, &
                                     -1.885040_dp, -1.887141_dp, -1.889241_dp, -1.891340_dp, -1.893437_dp, -1.895532_dp, &
                                     -1.897625_dp, -1.899717_dp, -1.901807_dp, -1.903895_dp, -1.905981_dp, -1.908066_dp, &
                                     -1.910149_dp, -1.912231_dp, -1.914310_dp, -1.916388_dp, -1.918464_dp, -1.920538_dp, &
                                     -1.922611_dp, -1.924682_dp, -1.926751_dp, -1.928818_dp, -1.930883_dp, -1.932947_dp, &
                                     -1.935009_dp, -1.937069_dp, -1.939127_dp, -1.941183_dp, -1.943238_dp, -1.945291_dp, &
                                     -1.947342_dp, -1.949391_dp, -1.951438_dp, -1.953483_dp, -1.955527_dp, -1.957568_dp, &
                                     -1.959608_dp, -1.961646_dp, -1.963682_dp, -1.965716_dp, -1.967748_dp, -1.969778_dp, &
                                     -1.971807_dp, -1.973833_dp, -1.975858_dp, -1.977880_dp, -1.979901_dp, -1.981920_dp, &
                                     -1.983937_dp, -1.985951_dp, -1.987964_dp, -1.989975_dp, -1.991984_dp, -1.993991_dp, &
                                     -1.995996_dp, -1.997999_dp, -2.000000_dp, -2.001999_dp, -2.003996_dp, -2.005991_dp, &
                                     -2.007984_dp, -2.009975_dp, -2.011964_dp, -2.013951_dp, -2.015935_dp, -2.017918_dp, &
                                     -2.019899_dp, -2.021878_dp, -2.023854_dp, -2.025829_dp, -2.027801_dp, -2.029772_dp, &
                                     -2.031740_dp, -2.033706_dp, -2.035670_dp, -2.037632_dp, -2.039592_dp, -2.041550_dp, &
                                     -2.043505_dp, -2.045459_dp, -2.047410_dp, -2.049359_dp, -2.051306_dp, -2.053251_dp, &
                                     -2.055194_dp, -2.057135_dp, -2.059073_dp, -2.061009_dp, -2.062943_dp, -2.064875_dp, &
                                     -2.066805_dp, -2.068732_dp, -2.070657_dp, -2.072580_dp, -2.074501_dp, -2.076420_dp, &
                                     -2.078336_dp, -2.080250_dp, -2.082162_dp, -2.084071_dp, -2.085979_dp, -2.087884_dp, &
                                     -2.089787_dp, -2.091687_dp, -2.093585_dp, -2.095481_dp, -2.097375_dp, -2.099266_dp, &
                                     -2.101155_dp, -2.103042_dp, -2.104927_dp, -2.106809_dp, -2.108688_dp, -2.110566_dp, &
                                     -2.112441_dp, -2.114314_dp, -2.116184_dp, -2.118052_dp, -2.119918_dp, -2.121781_dp, &
                                     -2.123642_dp, -2.125500_dp, -2.127357_dp, -2.129210_dp, -2.131062_dp, -2.132910_dp, &
                                     -2.134757_dp, -2.136601_dp, -2.138443_dp, -2.140282_dp, -2.142119_dp, -2.143953_dp, &
                                     -2.145785_dp, -2.147614_dp, -2.149441_dp, -2.151266_dp, -2.153088_dp, -2.154908_dp, &
                                     -2.156725_dp, -2.158539_dp, -2.160351_dp, -2.162161_dp, -2.163968_dp, -2.165772_dp, &
                                     -2.167575_dp, -2.169374_dp, -2.171171_dp, -2.172965_dp, -2.174757_dp, -2.176547_dp, &
                                     -2.178333_dp, -2.180118_dp, -2.181899_dp, -2.183678_dp, -2.185455_dp, -2.187229_dp, &
                                     -2.189000_dp]

    ! Expected result
    real(dp), dimension(301) :: expected = [-2.280000_dp, -2.279197_dp, -2.278388_dp, -2.277573_dp, -2.276752_dp, -2.275925_dp, &
                                            -2.275092_dp, -2.274253_dp, -2.273408_dp, -2.272557_dp, -2.271700_dp, -2.270837_dp, &
                                            -2.269968_dp, -2.269093_dp, -2.268212_dp, -2.267325_dp, -2.266432_dp, -2.265533_dp, &
                                            -2.264628_dp, -2.263717_dp, -2.262800_dp, -2.261877_dp, -2.260948_dp, -2.260013_dp, &
                                            -2.259072_dp, -2.258125_dp, -2.257172_dp, -2.256213_dp, -2.255248_dp, -2.254277_dp, &
                                            -2.253300_dp, -2.252317_dp, -2.251328_dp, -2.250333_dp, -2.249332_dp, -2.248325_dp, &
                                            -2.247312_dp, -2.246293_dp, -2.245268_dp, -2.244237_dp, -2.243200_dp, -2.242157_dp, &
                                            -2.241108_dp, -2.240053_dp, -2.238992_dp, -2.237925_dp, -2.236852_dp, -2.235773_dp, &
                                            -2.234688_dp, -2.233597_dp, -2.232500_dp, -2.231397_dp, -2.230288_dp, -2.229173_dp, &
                                            -2.228052_dp, -2.226925_dp, -2.225792_dp, -2.224653_dp, -2.223508_dp, -2.222357_dp, &
                                            -2.221200_dp, -2.220037_dp, -2.218868_dp, -2.217693_dp, -2.216512_dp, -2.215325_dp, &
                                            -2.214132_dp, -2.212933_dp, -2.211728_dp, -2.210517_dp, -2.209300_dp, -2.208077_dp, &
                                            -2.206848_dp, -2.205613_dp, -2.204372_dp, -2.203125_dp, -2.201872_dp, -2.200613_dp, &
                                            -2.199348_dp, -2.198077_dp, -2.196800_dp, -2.195517_dp, -2.194228_dp, -2.192933_dp, &
                                            -2.191632_dp, -2.190325_dp, -2.189012_dp, -2.187693_dp, -2.186368_dp, -2.185037_dp, &
                                            -2.183700_dp, -2.182357_dp, -2.181008_dp, -2.179653_dp, -2.178292_dp, -2.176925_dp, &
                                            -2.175552_dp, -2.174173_dp, -2.172788_dp, -2.171397_dp, -2.170000_dp, -2.168597_dp, &
                                            -2.167188_dp, -2.165773_dp, -2.164352_dp, -2.162925_dp, -2.161492_dp, -2.160053_dp, &
                                            -2.158608_dp, -2.157157_dp, -2.155700_dp, -2.154237_dp, -2.152768_dp, -2.151293_dp, &
                                            -2.149812_dp, -2.148325_dp, -2.146832_dp, -2.145333_dp, -2.143828_dp, -2.142317_dp, &
                                            -2.140800_dp, -2.139277_dp, -2.137748_dp, -2.136213_dp, -2.134672_dp, -2.133125_dp, &
                                            -2.131572_dp, -2.130013_dp, -2.128448_dp, -2.126877_dp, -2.125300_dp, -2.123717_dp, &
                                            -2.122128_dp, -2.120533_dp, -2.118932_dp, -2.117325_dp, -2.115712_dp, -2.114093_dp, &
                                            -2.112468_dp, -2.110837_dp, -2.109200_dp, -2.107557_dp, -2.105908_dp, -2.104253_dp, &
                                            -2.102592_dp, -2.100925_dp, -2.099252_dp, -2.097573_dp, -2.095888_dp, -2.094197_dp, &
                                            -2.092500_dp, -2.090797_dp, -2.089088_dp, -2.087373_dp, -2.085652_dp, -2.083925_dp, &
                                            -2.082192_dp, -2.080453_dp, -2.078708_dp, -2.076957_dp, -2.075200_dp, -2.073437_dp, &
                                            -2.071668_dp, -2.069893_dp, -2.068112_dp, -2.066325_dp, -2.064532_dp, -2.062733_dp, &
                                            -2.060928_dp, -2.059117_dp, -2.057300_dp, -2.055477_dp, -2.053648_dp, -2.051813_dp, &
                                            -2.049972_dp, -2.048125_dp, -2.046272_dp, -2.044413_dp, -2.042548_dp, -2.040677_dp, &
                                            -2.038800_dp, -2.036917_dp, -2.035028_dp, -2.033133_dp, -2.031232_dp, -2.029325_dp, &
                                            -2.027412_dp, -2.025493_dp, -2.023568_dp, -2.021637_dp, -2.019700_dp, -2.017757_dp, &
                                            -2.015808_dp, -2.013853_dp, -2.011892_dp, -2.009925_dp, -2.007952_dp, -2.005973_dp, &
                                            -2.003988_dp, -2.001997_dp, -2.000000_dp, -1.997997_dp, -1.995988_dp, -1.993973_dp, &
                                            -1.991952_dp, -1.989925_dp, -1.987892_dp, -1.985853_dp, -1.983808_dp, -1.981757_dp, &
                                            -1.979700_dp, -1.977637_dp, -1.975568_dp, -1.973493_dp, -1.971412_dp, -1.969325_dp, &
                                            -1.967232_dp, -1.965133_dp, -1.963028_dp, -1.960917_dp, -1.958800_dp, -1.956677_dp, &
                                            -1.954548_dp, -1.952413_dp, -1.950272_dp, -1.948125_dp, -1.945972_dp, -1.943813_dp, &
                                            -1.941648_dp, -1.939477_dp, -1.937300_dp, -1.935117_dp, -1.932928_dp, -1.930733_dp, &
                                            -1.928532_dp, -1.926325_dp, -1.924112_dp, -1.921893_dp, -1.919668_dp, -1.917437_dp, &
                                            -1.915200_dp, -1.912957_dp, -1.910708_dp, -1.908453_dp, -1.906192_dp, -1.903925_dp, &
                                            -1.901652_dp, -1.899373_dp, -1.897088_dp, -1.894797_dp, -1.892500_dp, -1.890197_dp, &
                                            -1.887888_dp, -1.885573_dp, -1.883252_dp, -1.880925_dp, -1.878592_dp, -1.876253_dp, &
                                            -1.873908_dp, -1.871557_dp, -1.869200_dp, -1.866837_dp, -1.864468_dp, -1.862093_dp, &
                                            -1.859712_dp, -1.857325_dp, -1.854932_dp, -1.852533_dp, -1.850128_dp, -1.847717_dp, &
                                            -1.845300_dp, -1.842877_dp, -1.840448_dp, -1.838013_dp, -1.835572_dp, -1.833125_dp, &
                                            -1.830672_dp, -1.828213_dp, -1.825748_dp, -1.823277_dp, -1.820800_dp, -1.818317_dp, &
                                            -1.815828_dp, -1.813333_dp, -1.810832_dp, -1.808325_dp, -1.805812_dp, -1.803293_dp, &
                                            -1.800768_dp, -1.798237_dp, -1.795700_dp, -1.793157_dp, -1.790608_dp, -1.788053_dp, &
                                            -1.785492_dp, -1.782925_dp, -1.780352_dp, -1.777773_dp, -1.775188_dp, -1.772597_dp, &
                                            -1.770000_dp]

    ! Computed result
    real(dp), dimension(301) :: computed

    ! Call the function
    computed = derivative(y, x)

    do i = 1, 301
      call check(error, computed(i), expected(i), thr=thr, rel=.false.)
    end do
  end subroutine test_derivative_3
  
  end module test_auxiliary

  
  